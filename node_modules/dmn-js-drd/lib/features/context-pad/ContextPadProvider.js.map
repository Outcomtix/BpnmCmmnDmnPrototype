{"version":3,"file":"ContextPadProvider.js","names":["assign","every","isArray","is","isAny","hasPrimaryModifier","ContextPadProvider","eventBus","contextPad","modeling","elementFactory","connect","create","rules","popupMenu","canvas","translate","config","injector","registerProvider","_contextPad","_modeling","_elementFactory","_connect","_create","_rules","_popupMenu","_canvas","_translate","autoPlace","_autoPlace","get","on","event","shape","context","entries","getEntries","replace","action","click","$inject","prototype","getContextPadEntries","element","actions","type","businessObject","startConnect","autoActivate","start","removeElement","e","removeElements","getReplaceMenuPosition","Y_OFFSET","pad","getPad","html","padRect","getBoundingClientRect","pos","x","left","y","bottom","appendAction","className","title","options","appendStart","createShape","source","hints","connectionTarget","append","group","dragstart","isEmpty","position","cursor","open","deleteAllowed","allowed","elements","getMultiElementContextPadEntries","_isDeleteAllowed","slice","allowedOrAllowedElements","el","includes"],"sources":["../../../src/features/context-pad/ContextPadProvider.js"],"sourcesContent":["import {\n  assign,\n  every,\n  isArray\n} from 'min-dash';\n\nimport {\n  is,\n  isAny\n} from 'dmn-js-shared/lib/util/ModelUtil';\n\nimport {\n  hasPrimaryModifier\n} from 'diagram-js/lib/util/Mouse';\n\n\n/**\n* A provider for DMN elements context pad\n*/\nexport default function ContextPadProvider(\n    eventBus, contextPad, modeling,\n    elementFactory, connect, create,\n    rules, popupMenu, canvas,\n    translate, config, injector) {\n\n  config = config || {};\n\n  contextPad.registerProvider(this);\n\n  this._contextPad = contextPad;\n\n  this._modeling = modeling;\n\n  this._elementFactory = elementFactory;\n  this._connect = connect;\n  this._create = create;\n  this._rules = rules;\n  this._popupMenu = popupMenu;\n  this._canvas = canvas;\n  this._translate = translate;\n\n  if (config.autoPlace !== false) {\n    this._autoPlace = injector.get('autoPlace', false);\n  }\n\n\n  eventBus.on('create.end', 250, function(event) {\n    var shape = event.context.shape;\n\n    if (!hasPrimaryModifier(event)) {\n      return;\n    }\n\n    var entries = contextPad.getEntries(shape);\n\n    if (entries.replace) {\n      entries.replace.action.click(event, shape);\n    }\n  });\n}\n\nContextPadProvider.$inject = [\n  'eventBus',\n  'contextPad',\n  'modeling',\n  'elementFactory',\n  'connect',\n  'create',\n  'rules',\n  'popupMenu',\n  'canvas',\n  'translate',\n  'config.contextPad',\n  'injector'\n];\n\n\nContextPadProvider.prototype.getContextPadEntries = function(element) {\n\n  var modeling = this._modeling,\n\n      elementFactory = this._elementFactory,\n      connect = this._connect,\n      create = this._create,\n      popupMenu = this._popupMenu,\n      contextPad = this._contextPad,\n      rules = this._rules,\n      translate = this._translate,\n      autoPlace = this._autoPlace;\n\n  var actions = {};\n\n  if (element.type === 'label') {\n    return actions;\n  }\n\n  var businessObject = element.businessObject;\n\n  function startConnect(event, element, autoActivate) {\n    connect.start(event, element, autoActivate);\n  }\n\n  function removeElement(e) {\n    modeling.removeElements([ element ]);\n  }\n\n  function getReplaceMenuPosition(element) {\n\n    var Y_OFFSET = 5;\n\n    var pad = contextPad.getPad(element).html;\n\n    var padRect = pad.getBoundingClientRect();\n\n    var pos = {\n      x: padRect.left,\n      y: padRect.bottom + Y_OFFSET\n    };\n\n    return pos;\n  }\n\n  /**\n  * Create an append action\n  *\n  * @param {string} type\n  * @param {string} className\n  * @param {string} title\n  * @param {Object} [options]\n  *\n  * @return {Object} descriptor\n  */\n  function appendAction(type, className, title, options) {\n\n    function appendStart(event, element) {\n\n      var shape = elementFactory.createShape(assign({ type: type }, options));\n\n      create.start(event, shape, {\n        source: element,\n        hints: {\n          connectionTarget: element\n        }\n      });\n    }\n\n    var append = autoPlace ? function(event, element) {\n      var shape = elementFactory.createShape(assign({ type: type }, options));\n\n      autoPlace.append(element, shape, {\n        connectionTarget: element\n      });\n    } : appendStart;\n\n    return {\n      group: 'model',\n      className: className,\n      title: title,\n      action: {\n        dragstart: appendStart,\n        click: append\n      }\n    };\n  }\n\n  if (is(businessObject, 'dmn:Decision')) {\n    assign(actions, {\n      'append.decision': appendAction(\n        'dmn:Decision',\n        'dmn-icon-decision',\n        translate('Append decision')\n      )\n    });\n  }\n\n  if (\n    isAny(businessObject, [\n      'dmn:BusinessKnowledgeModel',\n      'dmn:Decision',\n      'dmn:KnowledgeSource'\n    ])\n  ) {\n    assign(actions, {\n      'append.knowledge-source': appendAction(\n        'dmn:KnowledgeSource',\n        'dmn-icon-knowledge-source',\n        translate('Append knowledge source')\n      )\n    });\n  }\n\n  if (isAny(businessObject, [\n    'dmn:BusinessKnowledgeModel',\n    'dmn:Decision'\n  ])) {\n    assign(actions, {\n      'append.business-knowledge-model': appendAction(\n        'dmn:BusinessKnowledgeModel',\n        'dmn-icon-business-knowledge',\n        translate('Append business knowledge model')\n      )\n    });\n  }\n\n  if (isAny(businessObject, [ 'dmn:Decision', 'dmn:KnowledgeSource' ])) {\n    assign(actions, {\n      'append.input-data': appendAction(\n        'dmn:InputData',\n        'dmn-icon-input-data',\n        translate('Append input data')\n      )\n    });\n  }\n\n  if (is(businessObject, 'dmn:DRGElement')) {\n\n    assign(actions, {\n      'append.text-annotation': appendAction(\n        'dmn:TextAnnotation',\n        'dmn-icon-text-annotation',\n        translate('Add text annotation')\n      ),\n\n      'connect': {\n        group: 'connect',\n        className: 'dmn-icon-connection-multi',\n        title: translate(\n          'Connect to other element'\n        ),\n        action: {\n          click: startConnect,\n          dragstart: startConnect\n        }\n      }\n    });\n  }\n\n  if (is(businessObject, 'dmn:TextAnnotation')) {\n    assign(actions, {\n      'connect': {\n        group: 'connect',\n        className: 'dmn-icon-connection-multi',\n        title: translate(\n          'Connect to other element'\n        ),\n        action: {\n          click: startConnect,\n          dragstart: startConnect\n        }\n      }\n    });\n  }\n\n  if (!popupMenu.isEmpty(element, 'dmn-replace')) {\n\n    // Replace menu entry\n    assign(actions, {\n      'replace': {\n        group: 'edit',\n        className: 'dmn-icon-screw-wrench',\n        title: translate('Change type'),\n        action: {\n          click: function(event, element) {\n\n            var position = assign(getReplaceMenuPosition(element), {\n              cursor: { x: event.x, y: event.y }\n            });\n\n            popupMenu.open(element, 'dmn-replace', position);\n          }\n        }\n      }\n    });\n  }\n\n\n  // delete element entry, only show if allowed by rules\n  var deleteAllowed = rules.allowed('elements.delete', { elements: [ element ] });\n\n  if (isArray(deleteAllowed)) {\n\n    // was the element returned as a deletion candidate?\n    deleteAllowed = deleteAllowed[0] === element;\n  }\n\n  if (deleteAllowed) {\n    assign(actions, {\n      'delete': {\n        group: 'edit',\n        className: 'dmn-icon-trash',\n        title: translate('Delete'),\n        action: {\n          click: removeElement\n        }\n      }\n    });\n  }\n\n  return actions;\n};\n\nContextPadProvider.prototype.getMultiElementContextPadEntries = function(\n    elements\n) {\n  var modeling = this._modeling,\n      translate = this._translate;\n\n  var actions = {};\n\n  if (this._isDeleteAllowed(elements)) {\n    assign(actions, {\n      'delete': {\n        group: 'edit',\n        className: 'dmn-icon-trash',\n        title: translate('Delete'),\n        action: {\n          click: (e, elements) => modeling.removeElements(elements.slice())\n        },\n      },\n    });\n  }\n\n  return actions;\n};\n\nContextPadProvider.prototype._isDeleteAllowed = function(elements) {\n\n  // rules allowed can return boolean or array of elements (not reflected in type )\n  var allowedOrAllowedElements = this._rules.allowed('elements.delete', {\n    elements: elements\n  });\n\n  if (isArray(allowedOrAllowedElements)) {\n    return every(elements, el => allowedOrAllowedElements.includes(el));\n  }\n\n  return allowedOrAllowedElements;\n};\n\n\n"],"mappings":"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","ignoreList":[]}