{"version":3,"file":"LabelEditingProvider.js","names":["getLabel","is","assign","isDefined","MARKER_LABEL_HIDDEN","LabelEditingProvider","canvas","directEditing","eventBus","modeling","textRenderer","_canvas","_modeling","_textRenderer","_eventBus","registerProvider","on","event","activate","element","complete","cancel","e","shape","context","activeProvider","active","label","removeMarker","$inject","prototype","text","editingBBox","getEditingBBox","options","style","centerVertically","backgroundColor","border","resizable","addMarker","target","bbox","getAbsoluteBBox","bounds","x","y","zoom","defaultStyle","getDefaultStyle","defaultFontSize","fontSize","defaultLineHeight","lineHeight","fontFamily","fontWeight","width","height","paddingTop","paddingBottom","paddingLeft","paddingRight","minWidth","minHeight","textAlign","update","newLabel","activeContextText","newBounds","isEmptyText","updateLabel","trim"],"sources":["../../../src/features/label-editing/LabelEditingProvider.js"],"sourcesContent":["import { getLabel } from './LabelUtil';\n\nimport {\n  is\n} from 'dmn-js-shared/lib/util/ModelUtil';\n\nimport {\n  assign,\n  isDefined\n} from 'min-dash';\n\nvar MARKER_LABEL_HIDDEN = 'djs-label-hidden';\n\nexport default function LabelEditingProvider(\n    canvas,\n    directEditing,\n    eventBus,\n    modeling,\n    textRenderer\n) {\n\n  this._canvas = canvas;\n  this._modeling = modeling;\n  this._textRenderer = textRenderer;\n  this._eventBus = eventBus;\n\n  directEditing.registerProvider(this);\n\n  // listen to dblclick on non-root elements\n  eventBus.on('element.dblclick', function(event) {\n    directEditing.activate(event.element);\n  });\n\n  // complete on followup canvas operation\n  eventBus.on([\n    'autoPlace.start',\n    'canvas.viewbox.changing',\n    'drag.init',\n    'drillDown.click',\n    'element.mousedown',\n    'popupMenu.open',\n    'selection.changed'\n  ], function() {\n    directEditing.complete();\n  });\n\n  // cancel on command stack changes\n  eventBus.on([ 'commandStack.changed' ], function() {\n    directEditing.cancel();\n  });\n\n  eventBus.on('create.end', 500, function(e) {\n\n    var element = e.shape;\n\n    if (\n      is(element, 'dmn:Decision') ||\n      is(element, 'dmn:InputData') ||\n      is(element, 'dmn:BusinessKnowledgeModel') ||\n      is(element, 'dmn:KnowledgeSource') ||\n      is(element, 'dmn:TextAnnotation')\n    ) {\n      directEditing.activate(element);\n    }\n  });\n\n  eventBus.on('autoPlace.end', 500, function(event) {\n    directEditing.activate(event.shape);\n  });\n\n  this._eventBus.on([\n    'directEditing.complete', 'directEditing.cancel'\n  ], function(context) {\n    var activeProvider = context.active;\n\n    if (activeProvider) {\n      var element = activeProvider.element.label || activeProvider.element;\n      canvas.removeMarker(element, MARKER_LABEL_HIDDEN);\n    }\n  });\n}\n\nLabelEditingProvider.$inject = [\n  'canvas',\n  'directEditing',\n  'eventBus',\n  'modeling',\n  'textRenderer'\n];\n\n\n/**\n * Activate direct editing for drgs and text annotations.\n *\n * @param  {djs.model.Base} element\n *\n * @return {Object} an object with properties bounds (position and size) and text\n */\nLabelEditingProvider.prototype.activate = function(element) {\n\n  var text = getLabel(element);\n\n  if (!isDefined(text)) {\n    return;\n  }\n\n  var context = {\n    text: text\n  };\n\n  var editingBBox = this.getEditingBBox(element);\n\n  assign(context, editingBBox);\n\n  var options = {};\n  var style = context.style || {};\n\n  // DRG elements\n  if (is(element, 'dmn:DRGElement')) {\n    assign(options, {\n      centerVertically: true\n    });\n\n    assign(style, {\n      backgroundColor: null,\n      border: null\n    });\n  }\n\n  // text annotations\n  if (is(element, 'dmn:TextAnnotation')) {\n    assign(options, {\n      resizable: true\n    });\n  }\n\n  assign(context, {\n    options: options,\n    style: style\n  });\n\n  this._canvas.addMarker(element, MARKER_LABEL_HIDDEN);\n\n  return context;\n};\n\n\n/**\n * Get the editing bounding box based on the element's size and position\n *\n * @param  {djs.model.Base} element\n *\n * @return {Object}\n *         an object containing information about position and\n *         size (fixed or minimum and/or maximum)\n */\nLabelEditingProvider.prototype.getEditingBBox = function(element) {\n  var canvas = this._canvas;\n\n  var target = element.label || element;\n\n  var bbox = canvas.getAbsoluteBBox(target);\n\n  // default position\n  var bounds = { x: bbox.x, y: bbox.y };\n\n  var zoom = canvas.zoom();\n\n  var defaultStyle = this._textRenderer.getDefaultStyle();\n\n  // take zoom into account\n  var defaultFontSize = defaultStyle.fontSize * zoom,\n      defaultLineHeight = defaultStyle.lineHeight;\n\n  var style = {\n    fontFamily: this._textRenderer.getDefaultStyle().fontFamily,\n    fontWeight: this._textRenderer.getDefaultStyle().fontWeight\n  };\n\n  // DRG elements\n  if (is(element, 'dmn:DRGElement')) {\n    assign(bounds, {\n      width: bbox.width,\n      height: bbox.height\n    });\n\n    assign(style, {\n      fontSize: defaultFontSize + 'px',\n      lineHeight: defaultLineHeight,\n      paddingTop: (7 * zoom) + 'px',\n      paddingBottom: (7 * zoom) + 'px',\n      paddingLeft: (5 * zoom) + 'px',\n      paddingRight: (5 * zoom) + 'px'\n    });\n  }\n\n  // text annotations\n  if (is(element, 'dmn:TextAnnotation')) {\n    assign(bounds, {\n      width: bbox.width,\n      height: bbox.height,\n      minWidth: 30 * zoom,\n      minHeight: 10 * zoom\n    });\n\n    assign(style, {\n      textAlign: 'left',\n      paddingTop: (5 * zoom) + 'px',\n      paddingBottom: (7 * zoom) + 'px',\n      paddingLeft: (7 * zoom) + 'px',\n      paddingRight: (5 * zoom) + 'px',\n      fontSize: defaultFontSize + 'px',\n      lineHeight: defaultLineHeight\n    });\n  }\n\n  return { bounds: bounds, style: style };\n};\n\n\nLabelEditingProvider.prototype.update = function(\n    element,\n    newLabel,\n    activeContextText,\n    bounds\n) {\n  var newBounds,\n      bbox;\n\n  if (is(element, 'dmn:TextAnnotation')) {\n\n    bbox = this._canvas.getAbsoluteBBox(element);\n\n    newBounds = {\n      x: element.x,\n      y: element.y,\n      width: element.width / bbox.width * bounds.width,\n      height: element.height / bbox.height * bounds.height\n    };\n  }\n\n  if (isEmptyText(newLabel)) {\n    newLabel = null;\n  }\n\n  this._modeling.updateLabel(element, newLabel, newBounds);\n};\n\n// helpers //////////\n\nfunction isEmptyText(label) {\n  return !label || !label.trim();\n}"],"mappings":"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","ignoreList":[]}